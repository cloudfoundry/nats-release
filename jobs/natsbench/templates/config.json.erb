<%
  require 'json'
  config_json = {}

  nats_ips = nil
  if_p("nats.machines") { |ips| nats_ips = ips }
  nats_user = nil
  if_p("nats.user") { |user| nats_user = user }
  nats_password = nil
  if_p("nats.password") { |password| nats_password = password }
  nats_port = nil
  if_p("nats.port") { |port| nats_port = port }

  if_link('nats') do |nats_link|
    unless nats_ips
      nats_ips = nats_link.instances.map(&:address)
    end

    unless nats_user
      nats_user = nats_link.p("nats.user")
    end

    unless nats_password
      nats_password = nats_link.p("nats.password")
    end

    unless nats_port
      nats_port = nats_link.p("nats.port")
    end
  end
  nats_ips ||= []


  nats_tls_ips = []
  nats_tls_user = nil
  nats_tls_password = nil
  nats_tls_port = nil

  if_link('nats-tls') do |nats_tls_link|
    nats_tls_ips = nats_tls_link.instances.map(&:address)
    nats_tls_user = nats_tls_link.p("nats.user")
    nats_tls_password = nats_tls_link.p("nats.password")
    nats_tls_port = nats_tls_link.p("nats.port")
  end

  config_json = {
    "NonTLS" => {
      "Hosts" => nats_ips,
      "Port" => nats_port,
      "User" => nats_user,
      "Password" => nats_password
    },
    "TLS" => {
      "Hosts" => nats_tls_ips,
      "Port" => nats_tls_port,
      "User" => nats_tls_user,
      "Password" => nats_tls_password,
      "Certificate" => "/var/vcap/jobs/natsbench/config/client_tls/certificate.pem",
      "Ca" => "/var/vcap/jobs/natsbench/config/client_tls/ca.pem",
      "PrivateKey" => "/var/vcap/jobs/natsbench/config/client_tls/private_key.pem"
    }
  }
%>

<%= JSON.dump(config_json) %>
